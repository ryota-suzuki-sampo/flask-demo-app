<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>é›†è¨ˆã‚·ãƒ¼ãƒˆä½œæˆ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-light bg-white border-bottom mb-4">
  <div class="container-fluid">
    <span class="navbar-brand">ğŸš¢ èˆ¹èˆ¶ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </span>
  </div>
</nav>

<div class="container">
  <h2 class="mb-4">é›†è¨ˆã‚·ãƒ¼ãƒˆä½œæˆ</h2>

  <!-- â‘  start_month ã¨ template_file ã‚’åŒä¸€ãƒ•ã‚©ãƒ¼ãƒ ã«ã¾ã¨ã‚ã‚‹ -->
  <form 
    method="post" 
    action="/export_aggregated_excel" 
    enctype="multipart/form-data"
  >
    <!-- é–‹å§‹å¹´æœˆ -->
    <div class="mb-3">
      <label for="start_month" class="form-label">é–‹å§‹å¹´æœˆ</label>
      <input 
        type="month" 
        class="form-control" 
        id="start_month" 
        name="start_month"
        value="{{ now.strftime('%Y-%m') }}" 
        required
      >
    </div>

    <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ« -->
    <div class="mb-3">
      <label for="template_file" class="form-label">Excelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ</label>
      <input 
        type="file" 
        class="form-control" 
        id="template_file" 
        name="template_file"
        accept=".xlsx,.xls" 
        required
      >
    </div>

    <!-- ship_ids ã¯ localStorage ã‹ã‚‰ hidden input ã§è¿½åŠ  -->
    <button type="submit" class="btn btn-primary">é›†è¨ˆå®Ÿè¡Œ</button>
    <a href="/ships" class="btn btn-secondary ms-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
  </form>
</div>

<script>
  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã« ship_ids ã‚’ hidden input ã§è¿½åŠ 
  document.querySelector('form').addEventListener('submit', function(e) {
    // æ—¢å­˜ã® hidden ã‚’ã‚¯ãƒªã‚¢
    this.querySelectorAll('input[name="ship_ids"]').forEach(el => el.remove());

    // localStorage ã‹ã‚‰é¸æŠæ¸ˆã¿IDã‚’å–å¾—
    const selectedIds = JSON.parse(localStorage.getItem('selectedShipIds') || '[]');
    selectedIds.forEach(id => {
      const inp = document.createElement('input');
      inp.type = 'hidden';
      inp.name = 'ship_ids';
      inp.value = id;
      this.appendChild(inp);
    });

    // ship_ids ãŒç©ºãªã‚‰é€ä¿¡ã‚’æ­¢ã‚ã‚‹ï¼ˆä»»æ„ï¼‰
    if (selectedIds.length === 0) {
      e.preventDefault();
      alert('ã¾ãšèˆ¹èˆ¶ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
    }
  });
</script>
</body>
</html>
