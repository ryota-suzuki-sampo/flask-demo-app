<!-- templates/aggregate_start.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>é›†è¨ˆã‚·ãƒ¼ãƒˆä½œæˆ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-light bg-white border-bottom mb-4">
  <div class="container-fluid">
    <span class="navbar-brand">ğŸš¢ èˆ¹èˆ¶ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </span>
  </div>
</nav>
<div class="container">
  <h2 class="mb-4">é›†è¨ˆã‚·ãƒ¼ãƒˆä½œæˆ</h2>
  <!-- èˆ¹èˆ¶åä¸€è¦§è¡¨ç¤ºéƒ¨ -->
  <div class="mb-3">
    <label class="form-label">å¯¾è±¡èˆ¹èˆ¶</label>
    <ul id="ship-list" class="list-group"></ul>
  </div>
  <!-- é›†è¨ˆå®Ÿè¡Œãƒ•ã‚©ãƒ¼ãƒ  -->
  <form id="aggForm" method="post" action="/export_aggregated_excel" enctype="multipart/form-data">
  </form>

  <!-- 2é€šè²¨å¯¾å¿œé›†è¨ˆãƒ•ã‚©ãƒ¼ãƒ  -->
  <form id="aggForm2" method="post" action="/export_2currency_aggregated_excel" enctype="multipart/form-data">
    <div class="mb-3">
      <label for="start_month2" class="form-label">é–‹å§‹å¹´æœˆ</label>
      <input
        type="month"
        class="form-control"
        id="start_month2"
        name="start_month"
        value="{{ now.strftime('%Y-%m') }}"
        required
      >
    </div>
    <div class="mb-3">
      <label for="template_file2" class="form-label">Excelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ</label>
      <input
        type="file"
        class="form-control"
        id="template_file2"
        name="template_file"
        accept=".xlsx,.xls"
        required
      >
    </div>
    <button type="submit" class="btn btn-primary">2é€šè²¨é›†è¨ˆ å®Ÿè¡Œ</button>
    <a href="/ships" class="btn btn-secondary ms-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const shipListEl = document.getElementById('ship-list');
  const selectedIds = JSON.parse(localStorage.getItem('selectedShipIds') || '[]');

  // â‘  èˆ¹åè¡¨ç¤º
  if (selectedIds.length === 0) {
    shipListEl.innerHTML = '<li class="list-group-item">ï¼ˆèˆ¹èˆ¶ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰</li>';
  } else {
    fetch('/api/ship_names', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ship_ids: selectedIds})
    })
    .then(res => res.json())
    .then(names => {
      shipListEl.innerHTML = '';
      names.forEach(name => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = name;
        shipListEl.appendChild(li);
      });
    });
  }

  // å…±é€šã® ship_ids hidden è¿½åŠ å‡¦ç†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã«æ¸¡ã™ï¼‰
  function addShipIdsToForm(formEl) {
    formEl.querySelectorAll('input[name="ship_ids"]').forEach(el => el.remove());

    if (selectedIds.length === 0) {
      alert('ã¾ãšèˆ¹èˆ¶ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      return false;
    }
    selectedIds.forEach(id => {
      const inp = document.createElement('input');
      inp.type = 'hidden';
      inp.name = 'ship_ids';
      inp.value = id;
      formEl.appendChild(inp);
    });
    return true;
  }

  // â‘¡ é€šå¸¸é›†è¨ˆãƒ•ã‚©ãƒ¼ãƒ 
  const form1 = document.getElementById('aggForm');
  form1.addEventListener('submit', function(e) {
    if (!addShipIdsToForm(this)) e.preventDefault();
  });

  // â‘¢ 2é€šè²¨å¯¾å¿œé›†è¨ˆãƒ•ã‚©ãƒ¼ãƒ 
  const form2 = document.getElementById('aggForm2');
  console.log("form2:", form2);
  form2.addEventListener('submit', function(e) {
    if (!addShipIdsToForm(this)) {
      console.log("No ship_ids selected");
      e.preventDefault();
    } else {
      console.log("ship_ids added:", selectedIds); 
    }
  });
});
</script>
</body>
</html>
